// ================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
// ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Run Terminal >>  (if exist config\.finished del /f /q config\.finished) & (if exist config\.init_done del /f /q config\.init_done) & (if exist config\.phase1_next del /f /q config\.phase1_next) & (if exist config\.progress_writer del /f /q config\.progress_writer) & (if exist config\.report_writer del /f /q config\.report_writer) & (if exist config\.worker_count del /f /q config\.worker_count) & (if exist sync_ready.txt del /f /q sync_ready.txt) & (if exist config\.locks rmdir /s /q config\.locks) & (if exist config\.started rmdir /s /q config\.started) & (if exist config\results rmdir /s /q config\results) & npx playwright test e2e/OceanConnect/name_test-purchase-sms-otp-sync.spec.js --workers=6 --project=chromium
// ================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

// name_test-purchase-sms-otp-sync.spec.js  (CommonJS)
const { test, expect } = require('@playwright/test');
const fs = require('fs');
const path = require('path');

// ==============================
// Config files
// ==============================
const workerCountFile = 'config/.worker_count';
const barrierFile = path.resolve(process.cwd(), 'sync_ready.txt');
const phase1NextFile = path.resolve(process.cwd(), 'config/.phase1_next');
const progressWriterFile = path.resolve(process.cwd(), 'config/.progress_writer');
const resultsDir = path.resolve(process.cwd(), 'config/results'); // ‚¨ÖÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°


function setProgressWriter(seq) {
  ensureDirOf(progressWriterFile);
  try { fs.writeFileSync(progressWriterFile, String(seq), 'utf8'); } catch {}
}
function isProgressWriter(seq) {
  try {
    const v = fs.readFileSync(progressWriterFile, 'utf8').trim();
    return v === String(seq);
  } catch {
    return false;
  }
}

// ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô worker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (fallback = 1 ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ)
// let totalWorkers = 1;
// try {
//   totalWorkers = parseInt(
//     (fs.existsSync(workerCountFile) ? fs.readFileSync(workerCountFile, 'utf8') : '1').trim() || '1',
//     10
//   );
// } catch {
//   totalWorkers = 1;
// }

// ==============================
// Helpers: time + sleep
// ==============================
function now() {
  const d = new Date();
  const date = d.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    calendar: 'gregory' // üëà ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ ‡∏Ñ.‡∏®.
  }).split('/').reverse().join('-'); // YYYY-MM-DD

  const time = d.toLocaleTimeString('th-TH', { hour12: false }); // HH:mm:ss

  return `${date} ${time}`;
}

function sleep(ms) {
  return new Promise((r) => setTimeout(r, ms));
}
function ensureDirOf(filePath) {
  const dir = path.dirname(filePath);
  if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
}

// --- One-time init per whole run (‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥‡πÄ‡∏ß‡∏•‡∏≤ retry) ---
const initFlag = path.resolve(process.cwd(), 'config/.init_done');

function initOnce() {
  if (fs.existsSync(initFlag)) return;
  try { fs.rmSync(path.resolve(process.cwd(), 'config/.locks'),   { recursive: true, force: true }); } catch {}
  try { fs.rmSync(path.resolve(process.cwd(), 'config/.started'), { recursive: true, force: true }); } catch {}
  try { fs.unlinkSync(barrierFile); } catch {}
  try { fs.unlinkSync(path.resolve(process.cwd(), 'config/.finished')); } catch {}
  try { fs.unlinkSync(path.resolve(process.cwd(), 'config/.report_writer')); } catch {}
  try { fs.unlinkSync(path.resolve(process.cwd(), 'config/.progress_writer')); } catch {}
  try { fs.rmSync(resultsDir, { recursive: true, force: true }); } catch {}
  try { setNextSeq(1); } catch {}
  fs.writeFileSync(initFlag, '1', 'utf8');
}

// ‡∏ß‡∏≤‡∏á‡πÉ‡∏ï‡πâ Helpers: time + sleep
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô
function raceWithPageClose(page, promise, label = 'wait') {
  if (page.isClosed()) throw new Error(`Page already closed before ${label}`);

  return new Promise((resolve, reject) => {
    const onClose = () => reject(new Error(`Page closed during ${label}`));
    page.once('close', onClose);

    Promise.resolve(promise).then(
      (v) => { page.off('close', onClose); resolve(v); },
      (e) => { page.off('close', onClose); reject(e); }
    );
  });
}


async function ensureModalReady(page) {
  const modal = page.locator('div.modal-content', { hasText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô' });
  await raceWithPageClose(page, modal.waitFor({ state: 'visible', timeout: 30_000 }), 'modal visible');
  await raceWithPageClose(page, page.waitForTimeout(400), 'modal settle');
  await modal.evaluate(el => el.scrollIntoView({ block: 'center', behavior: 'auto' }));
  return modal;
}


async function clickWithRetries(locator, {
  tries = 4,
  perTryTimeout = 10_000,
  beforeEachTry = async () => {},
  name = 'target',
  page // üëà new: ‡∏™‡πà‡∏á page ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
} = {}) {
  let lastErr;
  for (let i = 1; i <= tries; i++) {
    try {
      if (page?.isClosed()) throw new Error('page closed');
      await beforeEachTry(i);

      await raceWithPageClose(page,
        locator.waitFor({ state: 'visible', timeout: perTryTimeout }),
        `wait ${name} visible`
      );

      const el = locator.first();
      await el.evaluate((btn) => {
        if (btn.hasAttribute('disabled') || btn.getAttribute('aria-disabled') === 'true') {
          throw new Error('Button disabled');
        }
      });

      await el.scrollIntoViewIfNeeded();
      await raceWithPageClose(page, el.click({ timeout: perTryTimeout }), `click ${name}`);
      return;
    } catch (err) {
      lastErr = err;
      console.warn(`‚ö†Ô∏è click ${name} ${i}/${tries} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message || err}`);
      if (i < tries) await sleep(300 + i * 300);
    }
  }
  throw lastErr;
}



// ------------------------------
// Dedup & Lock helpers (‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô + ‡∏Å‡∏±‡∏ô append ‡∏ã‡πâ‡∏≥)
// ------------------------------
const lockDir = path.resolve(process.cwd(), 'config/.locks');
function ensureLockDir() {
  if (!fs.existsSync(lockDir)) fs.mkdirSync(lockDir, { recursive: true });
}
// ‡∏•‡πá‡∏≠‡∏Å exclusive ‡∏ï‡πà‡∏≠ seq (‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏Ñ‡∏™ #8) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á retry/re-schedule
async function acquireSeqLock(seq) {
  ensureLockDir();
  const lockFile = path.join(lockDir, `seq-${seq}.lock`);
  while (true) {
    try {
      // 'wx' = ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞ throw ‚Üí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô
      const fd = fs.openSync(lockFile, 'wx');
      fs.closeSync(fd);
      return () => { try { fs.unlinkSync(lockFile); } catch {} };
    } catch {
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏ô‡∏≤‡∏ó‡∏µ
      try {
        const st = fs.statSync(lockFile);
        const ageMs = Date.now() - st.mtimeMs;
        if (ageMs > 20 * 60_000) fs.unlinkSync(lockFile);
      } catch {}
      await sleep(500 + Math.floor(Math.random() * 500));
    }
  }
}
// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "ready-N" ‡∏•‡∏á barrier ‡πÅ‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏ï‡πà‡∏≠ seq
function safeAppendReady(barrierPath, seq) {
  const line = `ready-${seq}`;
  let lines = [];
  if (fs.existsSync(barrierPath)) {
    lines = fs.readFileSync(barrierPath, 'utf8').split('\n').map(s => s.trim()).filter(Boolean);
    if (lines.includes(line)) return; // ‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥
  }
  fs.appendFileSync(barrierPath, line + '\n');
}

// ------------------------------
// Started flag (‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥‡∏ï‡πà‡∏≠ seq ‚Äî ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ race ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏à‡∏±‡∏ö‡∏ó‡∏±‡∏ô)
// ------------------------------
const startedDir = path.resolve(process.cwd(), 'config/.started');
function ensureStartedDir() {
  if (!fs.existsSync(startedDir)) fs.mkdirSync(startedDir, { recursive: true });
}
// function hasStarted(seq) {
//   ensureStartedDir();
//   const f = path.join(startedDir, `started-${seq}.flag`);
//   return fs.existsSync(f);
// }
// function markStarted(seq) {
//   ensureStartedDir();
//   const f = path.join(startedDir, `started-${seq}.flag`);
//   if (!fs.existsSync(f)) fs.writeFileSync(f, String(Date.now()), 'utf8');
// }

// ==============================
// Keep-Alive (‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö idle timeout)
// ==============================
// firstPing: 'immediate' = ‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå, ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏î)
// firstPing: 'delay'     = ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏ï‡∏≤‡∏° interval ‡∏Å‡πà‡∏≠‡∏ô ping ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
// firstPing: number(ms)  = ‡∏£‡∏∞‡∏ö‡∏∏ delay ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏≠‡∏á (ms)

function startKeepAlive(page, {
  intervalMs = 8 * 60_000,
  jitterMs = 30_000,
  logPrefix = '‚è≥ keep-alive',
  firstPing = 8 * 60_000 // 'immediate' | 'delay' | number
} = {}) {
  let stopped = false;
  const stop = () => { stopped = true; };
  const rand = (a,b)=>Math.floor(a + Math.random()*(b-a+1));
  const nextDelay = () => Math.max(5_000, intervalMs + rand(-jitterMs, jitterMs));

  // ‡∏ñ‡πâ‡∏≤ page ‡∏õ‡∏¥‡∏î ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  page.once('close', stop);

  (async () => {
    let first = true;
    // ‚¨á‚¨á‚¨á ‡∏ß‡∏≤‡∏á ‚Äú‡∏•‡∏π‡∏õ‡∏ô‡∏µ‡πâ‚Äù ‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚¨á‚¨á‚¨á
    while (!stopped) {
      let wait = nextDelay();
      if (first) {
        if (firstPing === 'immediate') wait = 0;
        else if (firstPing === 'delay') { /* keep */ }
        else if (typeof firstPing === 'number') wait = firstPing;
      }

      try {
        // ‡∏£‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠ page ‡∏õ‡∏¥‡∏î ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á
        await Promise.race([
          page.waitForTimeout(wait),
          page.waitForEvent('close', { timeout: 0 })
        ]);
        if (stopped || page.isClosed()) break;

        // ping ‡πÄ‡∏ö‡∏≤ ‡πÜ
        const x = 5 + Math.floor(Math.random()*10);
        const y = 5 + Math.floor(Math.random()*10);
        await page.mouse.move(x, y);
        await page.mouse.move(x+1, y+1);
        await page.keyboard.down('Shift'); await page.keyboard.up('Shift');
        await page.evaluate(() => {
          const e = new MouseEvent('mousemove', { bubbles:true, clientX:2, clientY:2 });
          document.dispatchEvent(e); window.dispatchEvent(new Event('focus'));
        });
        console.log(`${logPrefix}: ping`);
      } catch (e) {
        console.warn(`${logPrefix}: stop (${e?.message || e})`);
        break;
      }
      first = false;
    }
  })();

  return stop;
}



// ==============================
// Phase-1 Queue (‡∏ó‡∏µ‡∏•‡∏∞ worker ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏û‡∏ö)
// ==============================
function initPhase1Next() {
  ensureDirOf(phase1NextFile);
  if (!fs.existsSync(phase1NextFile)) {
    fs.writeFileSync(phase1NextFile, '1', 'utf8');
    console.log(`[init] phase1_next = 1`);
  }
}
function readNextSeq() {
  try {
    const v = fs.readFileSync(phase1NextFile, 'utf8').trim();
    return parseInt(v || '1', 10);
  } catch {
    return 1;
  }
}
function setNextSeq(n) {
  ensureDirOf(phase1NextFile);
  fs.writeFileSync(phase1NextFile, String(n), 'utf8');
}
async function waitForTurn(mySeq) {
  initPhase1Next();
  while (true) {
    const next = readNextSeq();
    if (next === mySeq) {
      console.log(`[${now()}] üë∑ Worker#${mySeq} ‡πÑ‡∏î‡πâ‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏° Phase-1`);
      return;
    }
    await sleep(50 + Math.floor(Math.random() * 100)); // anti-thundering herd
  }
}
function advanceTurn(mySeq) {
  const next = readNextSeq();
  if (next === mySeq) {
    setNextSeq(mySeq + 1);
    console.log(`[${now()}] ‚è≠Ô∏è ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ñ‡∏¥‡∏ß ‚Üí phase1_next = ${mySeq + 1}`);
  } else {
    console.log(`[${now()}] (info) phase1_next=${next} ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö mySeq=${mySeq}, ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ñ‡∏¥‡∏ß`);
  }
}

// ==============================
// Phase-2 Barrier (‡∏£‡∏≠‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å worker ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î "‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™")
// ==============================
async function waitForBarrierProgress(
  page,
  { seq, expected, settleMs = null, maxWaitMs = 30 * 60_000, render = true } = {}
) {
  const start = Date.now();
  let lastCount = -1;

  while (true) {
    if (page.isClosed()) throw new Error('Page closed during barrier wait');

    const lines = fs.existsSync(barrierFile)
      ? fs.readFileSync(barrierFile, 'utf8').trim().split('\n').filter(Boolean)
      : [];
    const count = new Set(lines).size;

    // ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞: count ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô + ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∑‡∏≠ "‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" + ‡πÄ‡∏õ‡∏¥‡∏î render
    if (count !== lastCount && render && isProgressWriter(seq)) {
      lastCount = count;
      const percent = (count / expected) * 100;
      const barLength = 20;
      const filledLength = Math.round((count / expected) * barLength);
      const bar = 'üü©'.repeat(filledLength) + '‚¨ú'.repeat(barLength - filledLength);
      process.stdout.write(`\rüîÑ Barrier Progress: ${bar} ${count}/${expected} (${percent.toFixed(1)}%)`);
    }

    if (count >= expected) {
      if (render && isProgressWriter(seq)) console.log(); // ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
      if (settleMs) {
        await Promise.race([
          page.waitForTimeout(settleMs),
          page.waitForEvent('close', { timeout: 0 })
        ]);
      }
      break;
    }

    if (Date.now() - start >= maxWaitMs) {
      throw new Error(`[barrier] timeout with ${count}/${expected}`);
    }

    await Promise.race([
      page.waitForTimeout(500),
      page.waitForEvent('close', { timeout: 0 })
    ]);
  }



  console.log(); // ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö
}


// üïê ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
const RUN = { startedAt: Date.now() };

function formatDuration(msTotal) {
  const ms = msTotal % 1000;
  const totalSec = Math.floor(msTotal / 1000);
  const s = totalSec % 60;
  const m = Math.floor(totalSec / 60) % 60;
  const h = Math.floor(totalSec / 3600);

  const parts = [];
  if (h > 0) parts.push(`${h}h`);
  if (m > 0) parts.push(`${m}m`);
  if (s > 0) parts.push(`${s}s`);
  if (ms > 0) parts.push(`${ms}ms`);

  return parts.join(' ');
}


function fmt(dt) {
  const iso = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Asia/Bangkok',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).format(dt);
  const time = dt.toLocaleTimeString('en-GB', {
    timeZone: 'Asia/Bangkok',
    hour12: false
  });
  return `${iso} ${time}`;
}


// üß† ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞ worker
const summaryMap = new Map();
function addResult(workerId, phone, refCode) {
  const rec = { workerId, phone, refCode };
  summaryMap.set(workerId, rec); // ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏î‡∏µ‡∏ö‡∏±‡∏Å)

  // ‚¨áÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ process ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  try {
    fs.mkdirSync(resultsDir, { recursive: true });
    const f = path.join(resultsDir, `worker-${String(workerId).padStart(2,'0')}.json`);
    fs.writeFileSync(f, JSON.stringify(rec), 'utf8');
  } catch {}
}

// ==============================
// Finish barrier + Report writer (‡∏Å‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤)
// ==============================
const finishedFile = path.resolve(process.cwd(), 'config/.finished');
const reportWriterFile = path.resolve(process.cwd(), 'config/.report_writer');

function safeAppendDone(finishedPath, seq) {
  const line = `done-${seq}`;
  let lines = [];
  if (fs.existsSync(finishedPath)) {
    lines = fs.readFileSync(finishedPath, 'utf8').split('\n').map(s => s.trim()).filter(Boolean);
    if (lines.includes(line)) return;
  }
  ensureDirOf(finishedPath);
  fs.appendFileSync(finishedPath, line + '\n');
}

// ‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏ô "‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" (‡∏°‡∏µ‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 1 ‡∏Ñ‡∏ô ‡∏î‡πâ‡∏ß‡∏¢ 'wx')
function tryBecomeReportWriter() {
  ensureDirOf(reportWriterFile);
  try {
    const fd = fs.openSync(reportWriterFile, 'wx'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
    fs.closeSync(fd); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πá‡πÑ‡∏î‡πâ
    return true;
  } catch {
    return false;
  }
}

// ‡∏£‡∏≠‡∏à‡∏ô done ‡∏Ñ‡∏£‡∏ö expected (poll ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤‡πÜ)
async function waitForAllFinished(expected, { timeoutMs = 30 * 60_000, pollMs = 300 } = {}) {
  const start = Date.now();
  let last = -1;
  while (true) {
    const lines = fs.existsSync(finishedFile)
      ? fs.readFileSync(finishedFile, 'utf8').trim().split('\n').filter(Boolean)
      : [];
    const count = new Set(lines).size;
    if (count !== last) {
      last = count;
      process.stdout.write(`\r‚úÖ Completed workers: ${count}/${expected}`);
    }
    if (count >= expected) { console.log(); return; }
    if (Date.now() - start > timeoutMs) throw new Error(`waitForAllFinished timeout: ${count}/${expected}`);
    await new Promise(r => setTimeout(r, pollMs));
  }
}


// ==============================
// Test data
// ==============================
const phonenos = ['0933995001','0933995002','0933995003','0933995004','0933995005','0933995006']; //,'0933995007','0933995008','0933995009','0933995010','0933995011','0933995012','0933995013','0933995014','0933995015','0933995016','0933995017']; //,'0933995018','0933995019','0933995020'
// ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® phonenos ‡πÄ‡∏™‡∏£‡πá‡∏à
let totalWorkers;
try {
  totalWorkers = parseInt(
    (fs.existsSync(workerCountFile) ? fs.readFileSync(workerCountFile, 'utf8') : String(phonenos.length)).trim() || String(phonenos.length),
    10
  );
} catch {
  totalWorkers = phonenos.length; // fallback ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
}
console.log(`[init] totalWorkers = ${totalWorkers}`);


// ==============================
// Tests
// ==============================
for (const [index, no] of phonenos.entries()) {
  test(`Purchase SMS OTP - ${index + 1}`, async ({ page }) => {
    const seq = index + 1; // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ï‡∏≤‡∏° array
    const phoneno = no;
    test.setTimeout(30 * 60_000); // 30 ‡∏ô‡∏≤‡∏ó‡∏µ

    // üîé ‡πÉ‡∏™‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ "‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ" ‡πÄ‡∏•‡∏¢ (‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô page ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
    page.on('close', () => console.warn(`[${now()}] [W${seq}] page.close()`));
    page.context().on('close', () => console.warn(`[${now()}] [W${seq}] context.close()`));
    page.context().browser()?.on('disconnected', () => console.warn(`[${now()}] [W${seq}] browser.disconnected`));
    page.setDefaultTimeout(30_000);
    page.setDefaultNavigationTimeout(60_000);

    initOnce();
    
    // (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå state ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
   if (seq === 1) {
    try { fs.rmSync(path.resolve(process.cwd(), 'config/.locks'), { recursive: true, force: true }); } catch {}
    try { fs.rmSync(path.resolve(process.cwd(), 'config/.started'), { recursive: true, force: true }); } catch {}
    try { fs.unlinkSync(barrierFile); } catch {}
    try { setNextSeq(1); } catch {}
    try { fs.rmSync(resultsDir, { recursive: true, force: true }); } catch {}
  }

    // üîí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô #8) ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á retry/re-schedule
    const releaseLock = await acquireSeqLock(seq);
  let stopKA;
  try {
    await waitForTurn(seq);

      // ---------- Phase-1: ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏° ----------
      // await waitForTurn(seq);

      const idcard = '4727713711739';
      const name = '‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
      const username = '‡πÄ‡∏ó‡∏™';
      
      const email = 'thanakrit.ph@ocean.co.th';

      // ====== Flow ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏ô‡∏ñ‡∏∂‡∏á "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" ======
      await page.goto('https://uat2-oceanlife.ochi.link/');
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ


      if (await page.locator('div[class="cookie-warning"]').isVisible({ timeout: 5000 })) {
        await page.locator('div[class="cookie-warning"]').getByRole('button', { name: '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö' }).click({ timeout: 10000 });
      }

      await page.getByRole('link', { name: '‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.locator('div:nth-child(4) > input').check();
      await page.locator('a[href="https://uat2-oceanlife.ochi.link/our-products/personal-accident/oceanlife-pa-easy?purchase_intent=1#purchase"]').click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.getByLabel('1 / 5').getByRole('button', { name: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.getByText('‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢').click({ timeout: 10000 });
      await page.getByRole('button', { name: '‡∏ï‡πà‡∏≠‡πÑ‡∏õ  ÔÅî' }).click({ timeout: 10000 }); // ‡∏£‡∏∞‡∏ß‡∏±‡∏á NBSP
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.getByText('‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢').click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.locator('input[name="birthdate"]').click({ timeout: 10000 });
      await page.getByRole('combobox').nth(3).selectOption('1996');
      await page.getByLabel('‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 1,').click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.getByText('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏ä‡∏µ‡∏û').nth(2).click({ timeout: 10000 });
      await page.locator('div').filter({ hasText: /^‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó$/ }).click({ timeout: 10000 });
      await page.waitForTimeout(1000);
      await page.getByText('‡∏≠‡∏≤‡∏ä‡∏µ‡∏û', { exact: true }).nth(2).click({ timeout: 10000 });
      await page.locator('div').filter({ hasText: /^‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£$/ }).click({ timeout: 10000 });
      await page.getByRole('button', { name: 'Ôá¨ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.getByRole('button', { name: 'ÔÅ∫ ‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.locator('input[name="applicant[id_card_no]"]').click({ timeout: 10000 });
      await page.locator('input[name="applicant[id_card_no]"]').type(idcard, { delay: 100 });
      await page.locator('#applicant-identity div').filter({ hasText: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏≠‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ‡∏ß‡∏±‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏û ‡∏ß‡∏±‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' }).locator('input[name="applicant[id_expired_date]"]').click({ timeout: 10000 });
      await page.getByRole('combobox').nth(2).selectOption('2026');
      await page.getByLabel('‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 8,').first().click({ timeout: 10000 });
      await page.locator('.selectbox__label').first().click({ timeout: 10000 });
      await page.locator('#applicant-profile div').filter({ hasText: /^‡∏ô‡∏≤‡∏¢$/ }).click({ timeout: 10000 });
      await page.locator('input[name="applicant[first_name]"]').click({ timeout: 10000 });
      await page.locator('input[name="applicant[first_name]"]').type(name, { delay: 100 });
      await page.locator('input[name="applicant[last_name]"]').click({ timeout: 10000 });
      await page.locator('input[name="applicant[last_name]"]').type(username, { delay: 100 });
      await page.locator('input[type="email"]').click({ timeout: 10000 });
      await page.locator('input[type="email"]').type(email, { delay: 100 });
      await page.locator('#applicant-profile div').filter({ hasText: '‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠' }).locator('input[type="text"]').click({ timeout: 10000 });
      await page.locator('#applicant-profile div').filter({ hasText: '‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠' }).locator('input[type="text"]').type(phoneno, { delay: 100 });
      await page.waitForTimeout(1000);
      await page.getByRole('button', { name: 'ÔÄå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' }).click({ timeout: 10000 });

      await page.locator('label').filter({ hasText: '‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢' }).click({ timeout: 10000 });
      await expect(page.locator('div[class="modal-content"]').getByText('‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå www.ocean.co.th')).toBeVisible({ timeout: 30000 });
      await page.locator('div[class="modal-content"]', { hasText: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' }).getByRole('button', { name: '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö', exact: true }).click({ timeout: 10000 });
      await expect(page.locator('div[class="modal-content"]').getByText('‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå www.ocean.co.th')).not.toBeVisible({ timeout: 30000 });

      await page.locator('label').filter({ hasText: '‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡πÄ‡∏≠‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤' }).click({ timeout: 10000 });
      await expect(page.locator('div[class="modal-content"]').getByText('‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏≠‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢/‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡πÇ‡∏î‡∏¢‡∏ä‡∏≠‡∏ö‡∏ò‡∏£‡∏£‡∏° ‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢ ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ')).toBeVisible({ timeout: 30000 });
      await page.locator('div[class="modal-content"]', { hasText: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' }).getByRole('button', { name: '‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö', exact: true }).click({ timeout: 10000 });
      await expect(page.locator('div[class="modal-content"]').getByText('‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏≠‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢/‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡πÇ‡∏î‡∏¢‡∏ä‡∏≠‡∏ö‡∏ò‡∏£‡∏£‡∏° ‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢ ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ')).not.toBeVisible({ timeout: 30000 });

      await page.getByRole('button', { name: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.locator('input[name="question[138][7]"]').click({ timeout: 10000 });
      await page.locator('input[name="question[138][7]"]').type('175');
      await page.locator('input[name="question[139][8]"]').click({ timeout: 10000 });
      await page.locator('input[name="question[139][8]"]').type('90');
      await page.getByRole('button', { name: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.getByText('‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥').nth(2).click({ timeout: 10000 });
      await page.getByText('‡πÑ‡∏ó‡∏¢', { exact: true }).nth(1).click({ timeout: 10000 });
      await page.locator('input[name="applicant[main_occupation_position]"]').click({ timeout: 10000 });
      await page.locator('input[name="applicant[main_occupation_position]"]').type('‡∏ó‡∏î‡∏™‡∏≠‡∏ö', { delay: 100 });
      await page.getByRole('textbox', { name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ï‡πà‡∏≠‡∏õ‡∏µ)' }).click({ timeout: 10000 });
      await page.getByRole('textbox', { name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ï‡πà‡∏≠‡∏õ‡∏µ)' }).type('20,0000', { delay: 100 });
      await page.getByRole('textbox', { name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' }).click({ timeout: 10000 });
      await page.getByRole('textbox', { name: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' }).type('111', { delay: 100 });
      await page.locator('input[name="applicant[address_registered][postal_code]"]').click({ timeout: 10000 });
      await page.locator('input[name="applicant[address_registered][postal_code]"]').type('10600', { delay: 100 });
      await page.getByText('- ‡∏ß‡∏±‡∏î‡∏ó‡πà‡∏≤‡∏û‡∏£‡∏∞ ‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£').click({ timeout: 10000 });
      await page.waitForTimeout(1000);
      await page.getByRole('button', { name: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.getByText('‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠').nth(2).click({ timeout: 10000 });
      await page.locator('div').filter({ hasText: /^‡∏ô‡∏≤‡∏¢$/ }).click({ timeout: 10000 });
      await page.getByRole('textbox').nth(4).click({ timeout: 10000 });
      await page.getByRole('textbox').nth(4).type('‡∏ó‡∏î‡∏™‡∏≠‡∏ö', { delay: 100 });
      await page.getByRole('textbox').nth(5).click({ timeout: 10000 });
      await page.getByRole('textbox').nth(5).type('‡πÄ‡∏ó‡∏™', { delay: 100 });
      await page.getByText('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå').nth(2).click({ timeout: 10000 });
      await page.locator('div').filter({ hasText: /^‡∏ö‡∏¥‡∏î‡∏≤$/ }).click({ timeout: 10000 });
      await page.getByRole('spinbutton').nth(1).click({ timeout: 10000 });
      await page.getByRole('spinbutton').nth(1).type('30', { delay: 100 });
      await page.getByRole('button', { name: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.getByText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå').click({ timeout: 10000 });
      await page.getByRole('button', { name: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      const fileInput_idcard_front = page.locator('input[name="idcard_front"]');
      await fileInput_idcard_front.setInputFiles('C:/Users/rangsiman.ph/Documents/GitHub/Playwright-Automation/pic/ochi-thank@2x.png');
      const fileInput_selfie = page.locator('input[name="selfie"]');
      await fileInput_selfie.setInputFiles('C:/Users/rangsiman.ph/Documents/GitHub/Playwright-Automation/pic/ochi-thank@2x.png');
      const fileInput_idcard = page.locator('input[name="idcard_selfie"]');
      await fileInput_idcard.setInputFiles('C:/Users/rangsiman.ph/Documents/GitHub/Playwright-Automation/pic/ochi-thank@2x.png');
      await page.waitForTimeout(1000);
      await page.getByRole('button', { name: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.waitForTimeout(1000);
      await page.getByRole('button', { name: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' }).click({ timeout: 10000 });
      await raceWithPageClose(page, page.waitForLoadState('networkidle'), 'networkidle');
// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å waitForLoadState ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÜ

      await page.waitForTimeout(1000);
      await page.getByRole('button', { name: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' }).click({ timeout: 10000 });
      await expect(page.locator('div[class="modal-content "]', { hasText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô' })).toBeVisible({ timeout: 30000 });

      console.log(`[${now()}] üöÄ Worker ${seq}: reached meeting point (‡∏Å‡πà‡∏≠‡∏ô "‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™")`);

      // ---------- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î Phase-1 ‡∏Ç‡∏≠‡∏á worker ‡∏ô‡∏µ‡πâ: ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ----------
      advanceTurn(seq);

     // ---------- ‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ barrier (‡∏Å‡∏±‡∏ô append ‡∏ã‡πâ‡∏≥) ----------
safeAppendReady(barrierFile, seq);
setProgressWriter(seq); // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô progress writer

// ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏° keep-alive "‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠ barrier" (‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
stopKA = startKeepAlive(page, {
  intervalMs: 5 * 60_000,
  jitterMs: 30_000,
  logPrefix: `‚è≥ keep-alive [W${seq}]`,
  firstPing: 'immediate'
});

// ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å worker ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏à‡∏£‡∏¥‡∏á ‡πÜ
const expectedReady = Math.min(totalWorkers || phonenos.length, phonenos.length);


// ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å progress bar ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
await waitForBarrierProgress(page, {
  seq,// ‡∏™‡πà‡∏á seq ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
  expected: expectedReady,
  settleMs: 1000,
  maxWaitMs: 10 * 60_000,
  render: true
});

console.log(`[${now()}] üöÄ Worker ${seq}: starting Phase-2`);

// (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ UI ‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÅ‡∏ó‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà
// const jitter = (seq % 7) * 120; // ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ~720ms
// await page.waitForTimeout(jitter);

// ‡πÉ‡∏´‡πâ modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô
const modal = await ensureModalReady(page);
const btnRequest = modal.getByRole('button', { name: '‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™' });


 

// ‡∏Å‡∏î‡∏î‡πâ‡∏ß‡∏¢ retry ‡∏ó‡∏µ‡πà‡∏ó‡∏ô‡∏ï‡πà‡∏≠ re-render/disabled/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠
await clickWithRetries(btnRequest, {
  tries: 4,
  perTryTimeout: 10_000,
  name: '‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™',
  page,
  beforeEachTry: async () => {
    if (!(await modal.isVisible().catch(()=>false))) await ensureModalReady(page);
  }
});


// ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å
const refText = await page
  .locator('div.modal-content', { hasText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô' })
  .locator('p')
  .nth(2)
  .textContent({ timeout: 15_000 });

// ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‚Äù ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏û‡πà‡∏ß‡∏á)
const refCode = (refText || '').trim().match(/[A-Z0-9]{4,}/)?.[0] || (refText || '').trim();

// ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏´‡πâ worker ‡∏ô‡∏µ‡πâ (‡πÉ‡∏ä‡πâ seq/phoneno ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡∏™)
addResult(seq, phoneno, refCode);

console.log(`Worker ${seq} : ${refCode}`);


// console.log(`Worker ${seq} : ${refcode ? refcode.trim() : ''}`);

    } finally {
       try { safeAppendDone(finishedFile, seq); } catch {}   // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ worker ‡∏ô‡∏µ‡πâ ‚Äú‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß‚Äù
      // üóùÔ∏è ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ (‡∏Å‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á)
      try { stopKA?.(); } catch { stopKA = null; }
      try { releaseLock(); } catch {}
    }
    
  });
}
test.afterAll(async () => {
  const expectedReady = Math.min(totalWorkers || phonenos.length, phonenos.length);

  if (!tryBecomeReportWriter()) return;   // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏•‡πá‡∏≠‡∏Å

  await waitForAllFinished(expectedReady, { timeoutMs: 30 * 60_000, pollMs: 500 });

  // ‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏∏‡∏Å worker
  let summaryResults = [];
  try {
    if (fs.existsSync(resultsDir)) {
      const files = fs.readdirSync(resultsDir).filter(f => f.endsWith('.json'));
      summaryResults = files.map(f => {
        try { return JSON.parse(fs.readFileSync(path.join(resultsDir, f), 'utf8')); }
        catch { return null; }
      }).filter(Boolean).sort((a,b) => a.workerId - b.workerId);
    }
  } catch {}

  const endedAt = Date.now();
  const started = new Date(RUN.startedAt);
  const ended   = new Date(endedAt);
  const spentMs = endedAt - RUN.startedAt;

  console.log('\nüß™‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log('üìä FINAL OTP TEST REPORT');
  console.log(`üïê Started:   ${fmt(started)}`);
  console.log(`üïõ Finished:  ${fmt(ended)}`);
  console.log(`üïõ Duration:  ${formatDuration(spentMs)}`);
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

  summaryResults.forEach(r => {
    console.log(`üë∑ Worker #${String(r.workerId).padStart(2,' ')} ‚îÇ üìû ${r.phone.padEnd(12)} ‚îÇ üìå ${r.refCode}`);
  });

  console.log(`\n‚úÖ Total Workers: ${summaryResults.length}`);
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
});
